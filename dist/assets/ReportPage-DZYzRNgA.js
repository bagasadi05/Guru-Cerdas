import{a7 as O,u as W,b as H,r as d,g as Q,j as e,t as D,B as f,a9 as v,i as U,K as J,S as V,w as I,L as z,G as X,R as Z,x as K,s as g}from"./index-D1C6o8KR.js";import{g as ee}from"./pdfGenerator-DW_90Ppn.js";import{E as ae}from"./jspdf.plugin.autotable-Cos_-fnW.js";import{F as re}from"./FloatingActionButton-CQmhLiOc.js";const se=async(t,n)=>{const c=await g.from("students").select("*, classes(id, name)").eq("id",t).eq("user_id",n).single();if(c.error)throw new Error(c.error.message);const[o,u,m,b,h]=await Promise.all([g.from("reports").select("*").eq("student_id",t),g.from("attendance").select("*").eq("student_id",t),g.from("academic_records").select("*").eq("student_id",t),g.from("violations").select("*").eq("student_id",t),g.from("quiz_points").select("*").eq("student_id",t)]),p=[o,u,m,b,h].map(x=>x.error).filter(Boolean);if(p.length>0)throw new Error(p.map(x=>x.message).join(", "));return{student:c.data,reports:o.data||[],attendanceRecords:u.data||[],academicRecords:m.data||[],violations:b.data||[],quizPoints:h.data||[]}},ie=()=>{var C,P;const{studentId:t}=O(),{user:n}=W(),c=H(),[o,u]=d.useState(!0),[m,b]=d.useState(new Set),[h,p]=d.useState(""),[x,$]=d.useState(new Date().toISOString().split("T")[0]),[y,q]=d.useState("Ganjil"),[N,L]=d.useState(`${new Date().getFullYear()} / ${new Date().getFullYear()+1}`),[T,S]=d.useState(!1),[_,R]=d.useState(!1),{data:r,isLoading:B,isError:G,error:M}=Q({queryKey:["reportData",t,n==null?void 0:n.id],queryFn:()=>se(t,n.id),enabled:!!t&&!!n}),F=async()=>{if(!(!r||!K)){R(!0);try{const a=`
                Buatkan catatan wali kelas untuk rapor siswa berikut:
                Nama: ${r.student.name}
                Rata-rata Nilai: ${Math.round(r.academicRecords.reduce((l,k)=>l+k.score,0)/(r.academicRecords.length||1))}
                Total Pelanggaran: ${r.violations.length}
                Total Kehadiran: ${r.attendanceRecords.filter(l=>l.status==="Hadir").length} dari ${r.attendanceRecords.length} hari.
                
                Berikan catatan yang motivatif, personal, dan profesional dalam 2-3 kalimat. Bahasa Indonesia.
            `,i=(await K.models.generateContent({model:"gemini-1.5-flash",contents:a})).text||"";p(i.trim()),c.success("Catatan berhasil dibuat oleh AI!")}catch(a){console.error(a),c.error("Gagal membuat catatan AI.")}finally{R(!1)}}},j=d.useMemo(()=>r?[...new Set(r.academicRecords.map(a=>a.subject||"Lainnya"))]:[],[r]);d.useEffect(()=>{j.length>0&&m.size===0&&b(new Set(j))},[j]);const E=a=>{b(s=>{const i=new Set(s);return i.has(a)?i.delete(a):i.add(a),i})},A=()=>{if(!r){c.error("Data laporan tidak tersedia untuk dicetak.");return}try{const a=new ae({orientation:"portrait",unit:"mm",format:"a4"});ee(a,r,h,x,y,N,n),a.save(`Rapor_${r.student.name}.pdf`),c.success("Rapor berhasil diunduh sebagai PDF!")}catch(a){c.error(`Gagal membuat PDF: ${a.message}`)}},Y=d.useMemo(()=>r?(o?r.academicRecords:r.academicRecords.filter(s=>m.has(s.subject||"Lainnya"))).reduce((s,i)=>{const l=i.subject||"Lainnya";return s[l]||(s[l]=[]),s[l].push(i),s},{}):{},[r,o,m]),w=d.useMemo(()=>r?r.attendanceRecords.reduce((a,s)=>(s.status!=="Hadir"&&(a[s.status]=(a[s.status]||0)+1),a),{Sakit:0,Izin:0,Alpha:0}):{Sakit:0,Izin:0,Alpha:0},[r]);return B?e.jsx("div",{className:"flex items-center justify-center h-screen bg-gray-100 dark:bg-gray-900",children:e.jsx("div",{className:"w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"})}):G?e.jsxs("div",{className:"flex items-center justify-center h-screen bg-gray-100 dark:bg-gray-900 text-red-500",children:["Error: ",M.message]}):r?e.jsxs("div",{className:"h-screen flex flex-col md:flex-row bg-gray-100 dark:bg-gray-900 font-sans overflow-hidden",children:[e.jsxs("aside",{className:`
                fixed inset-y-0 left-0 z-30 w-full md:w-80 bg-white dark:bg-gray-800 shadow-xl transform transition-transform duration-300 ease-in-out
                ${T?"translate-x-0":"-translate-x-full"} md:relative md:translate-x-0 md:shadow-none border-r border-gray-200 dark:border-gray-700 flex flex-col
            `,children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-900/50",children:[e.jsxs("h2",{className:"font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2",children:[e.jsx(D,{className:"w-5 h-5"}),"Pengaturan Rapor"]}),e.jsx(f,{variant:"ghost",size:"icon",className:"md:hidden",onClick:()=>S(!1),children:e.jsx(v,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Tahun Ajaran"}),e.jsx("input",{type:"text",value:N,onChange:a=>L(a.target.value),className:"w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Contoh: 2024 / 2025"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Semester"}),e.jsxs("select",{value:y,onChange:a=>q(a.target.value),className:"w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"Ganjil",children:"Ganjil"}),e.jsx("option",{value:"Genap",children:"Genap"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4"}),"Tanggal Rapor"]}),e.jsx("input",{type:"date",value:x,onChange:a=>$(a.target.value),className:"w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4"}),"Catatan Wali Kelas"]}),e.jsxs(f,{size:"sm",variant:"outline",onClick:F,disabled:_,className:"text-purple-600 border-purple-200 hover:bg-purple-50 dark:border-purple-800 dark:text-purple-400 dark:hover:bg-purple-900/30 text-xs h-7 px-2",children:[_?e.jsx("span",{className:"animate-spin mr-1",children:"â³"}):e.jsx(V,{className:"w-3 h-3 mr-1"}),"Buat dengan AI"]})]}),e.jsx("textarea",{value:h,onChange:a=>p(a.target.value),rows:6,className:"w-full rounded-lg border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm p-3",placeholder:"Tulis catatan untuk siswa..."}),e.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Catatan ini akan muncul di bagian bawah rapor."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:"Filter Mata Pelajaran"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>{u(!0),b(new Set(j))},className:`px-3 py-1.5 text-xs rounded-lg border transition-all ${o?"bg-blue-50 border-blue-200 text-blue-700 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-300 font-medium":"bg-white border-gray-200 text-gray-600 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300"}`,children:"Semua"}),e.jsx("button",{onClick:()=>u(!1),className:`px-3 py-1.5 text-xs rounded-lg border transition-all ${o?"bg-white border-gray-200 text-gray-600 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300":"bg-blue-50 border-blue-200 text-blue-700 dark:bg-blue-900/30 dark:border-blue-800 dark:text-blue-300 font-medium"}`,children:"Pilih Manual"})]}),!o&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2 p-3 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-gray-100 dark:border-gray-700",children:j.map(a=>e.jsx("button",{onClick:()=>E(a),className:`px-2 py-1 text-xs rounded-md border transition-all ${m.has(a)?"bg-green-50 border-green-200 text-green-700 dark:bg-green-900/30 dark:border-green-800 dark:text-green-300":"bg-white border-gray-200 text-gray-500 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-400"}`,children:a},a))})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50",children:e.jsxs(f,{onClick:A,className:"w-full bg-purple-600 hover:bg-purple-700 text-white shadow-lg shadow-purple-500/20",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Cetak PDF Sekarang"]})})]}),e.jsxs("div",{className:"flex-1 flex flex-col h-full overflow-hidden relative",children:[e.jsxs("header",{className:"flex-shrink-0 h-16 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 md:hidden z-20",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(z,{to:`/siswa/${t}`,className:"p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800",children:e.jsx(v,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"})}),e.jsx("h1",{className:"font-bold text-gray-900 dark:text-white",children:"Pratinjau Rapor"})]}),e.jsx(f,{variant:"ghost",size:"icon",onClick:()=>S(!0),children:e.jsx(D,{className:"w-5 h-5 text-gray-600 dark:text-gray-400"})})]}),e.jsxs("header",{className:"hidden md:flex flex-shrink-0 h-16 bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 items-center justify-between px-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(z,{to:`/siswa/${t}`,children:e.jsxs(f,{variant:"ghost",size:"sm",className:"text-gray-600 dark:text-gray-400",children:[e.jsx(v,{className:"w-4 h-4 mr-2"})," Kembali"]})}),e.jsx("div",{className:"h-6 w-px bg-gray-300 dark:bg-gray-700"}),e.jsx("h1",{className:"font-bold text-lg text-gray-900 dark:text-white",children:"Pratinjau Rapor Siswa"})]}),e.jsxs("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:[r.student.name," - Kelas ",(C=r.student.classes)==null?void 0:C.name]})]}),e.jsx("main",{className:"flex-1 overflow-y-auto bg-gray-100 dark:bg-gray-900 p-2 md:p-8 flex justify-center",children:e.jsxs("div",{id:"printable-area",className:"w-full md:w-[210mm] md:min-h-[297mm] bg-white text-black shadow-sm md:shadow-2xl rounded-sm p-4 md:p-[20mm] origin-top transform transition-transform",children:[e.jsx("header",{className:"text-center border-b-2 border-black pb-4 mb-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row justify-center items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 md:w-16 md:h-16 bg-gray-200 rounded-full flex items-center justify-center",children:e.jsx(X,{className:"w-6 h-6 md:w-8 md:h-8 text-black"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg md:text-xl font-bold uppercase tracking-wider",children:"Laporan Hasil Belajar"}),e.jsx("h2",{className:"text-xs md:text-sm font-medium mt-1",children:"MI AL IRSYAD AL ISLAMIYYAH KOTA MADIUN"})]})]})}),e.jsx("div",{className:"mb-6 md:mb-8",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{className:"grid grid-cols-[100px_1fr] gap-2",children:[e.jsx("span",{className:"font-bold",children:"Nama Siswa"}),e.jsxs("span",{children:[": ",r.student.name]}),e.jsx("span",{className:"font-bold",children:"Kelas"}),e.jsxs("span",{children:[": ",((P=r.student.classes)==null?void 0:P.name)||"N/A"]})]}),e.jsxs("div",{className:"grid grid-cols-[100px_1fr] gap-2",children:[e.jsx("span",{className:"font-bold",children:"Tahun Ajaran"}),e.jsxs("span",{children:[": ",N]}),e.jsx("span",{className:"font-bold",children:"Semester"}),e.jsxs("span",{children:[": ",y]})]})]})}),e.jsxs("section",{className:"mb-6 md:mb-8",children:[e.jsx("h3",{className:"text-sm md:text-base font-bold mb-3 border-b border-black pb-1",children:"A. Capaian Akademik"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs md:text-sm border-collapse border border-black min-w-[600px] md:min-w-0",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border border-black p-2 text-center w-8 md:w-10",children:"No"}),e.jsx("th",{className:"border border-black p-2 text-left",children:"Mata Pelajaran"}),e.jsx("th",{className:"border border-black p-2 text-left",children:"Penilaian"}),e.jsx("th",{className:"border border-black p-2 text-center w-12 md:w-16",children:"Nilai"}),e.jsx("th",{className:"border border-black p-2 text-left",children:"Deskripsi"})]})}),e.jsx("tbody",{children:Object.entries(Y).map(([a,s],i)=>e.jsx(Z.Fragment,{children:s.map((l,k)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border border-black p-2 text-center",children:k===0?i+1:""}),e.jsx("td",{className:"border border-black p-2 font-medium",children:k===0?a:""}),e.jsx("td",{className:"border border-black p-2",children:l.assessment_name||"-"}),e.jsx("td",{className:"border border-black p-2 text-center font-bold",children:l.score}),e.jsx("td",{className:"border border-black p-2 text-xs italic",children:l.notes||"Capaian sesuai dengan nilai yang diperoleh."})]},l.id))},a))})]})})]}),e.jsxs("section",{className:"mb-6 md:mb-8 flex flex-col md:flex-row gap-6 md:gap-8",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm md:text-base font-bold mb-3 border-b border-black pb-1",children:"B. Ketidakhadiran"}),e.jsx("table",{className:"w-full text-xs md:text-sm border-collapse border border-black",children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{className:"border border-black p-2",children:"Sakit"}),e.jsxs("td",{className:"border border-black p-2 text-center font-bold",children:[w.Sakit," hari"]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"border border-black p-2",children:"Izin"}),e.jsxs("td",{className:"border border-black p-2 text-center font-bold",children:[w.Izin," hari"]})]}),e.jsxs("tr",{children:[e.jsx("td",{className:"border border-black p-2",children:"Tanpa Keterangan"}),e.jsxs("td",{className:"border border-black p-2 text-center font-bold",children:[w.Alpha," hari"]})]})]})})]}),e.jsxs("div",{className:"flex-[1.5]",children:[e.jsx("h3",{className:"text-sm md:text-base font-bold mb-3 border-b border-black pb-1",children:"C. Catatan Perilaku"}),e.jsx("div",{className:"border border-black p-3 min-h-[80px] md:min-h-[100px] text-xs md:text-sm",children:e.jsx("ul",{className:"list-disc list-inside space-y-1",children:(r.violations||[]).length>0?(r.violations||[]).map(a=>e.jsx("li",{children:a.description},a.id)):e.jsx("li",{children:"Siswa menunjukkan sikap yang baik dan terpuji selama pembelajaran."})})})]})]}),(r.quizPoints||[]).length>0&&e.jsxs("section",{className:"mb-6 md:mb-8",children:[e.jsx("h3",{className:"text-sm md:text-base font-bold mb-3 border-b border-black pb-1",children:"D. Keaktifan & Prestasi"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-xs md:text-sm border-collapse border border-black min-w-[600px] md:min-w-0",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border border-black p-2 text-center w-10",children:"No"}),e.jsx("th",{className:"border border-black p-2 text-left",children:"Kegiatan"}),e.jsx("th",{className:"border border-black p-2 text-center w-20",children:"Poin"}),e.jsx("th",{className:"border border-black p-2 text-center w-32",children:"Tanggal"})]})}),e.jsx("tbody",{children:r.quizPoints.map((a,s)=>e.jsxs("tr",{children:[e.jsx("td",{className:"border border-black p-2 text-center",children:s+1}),e.jsx("td",{className:"border border-black p-2",children:a.quiz_name}),e.jsx("td",{className:"border border-black p-2 text-center font-bold",children:a.points}),e.jsx("td",{className:"border border-black p-2 text-center",children:new Date(a.created_at).toLocaleDateString("id-ID")})]},a.id))})]})})]}),e.jsxs("section",{className:"mb-8 md:mb-12",children:[e.jsx("h3",{className:"text-sm md:text-base font-bold mb-3 border-b border-black pb-1",children:(r.quizPoints||[]).length>0?"E. Catatan Wali Kelas":"D. Catatan Wali Kelas"}),e.jsx("div",{className:"border border-black p-3 md:p-4 min-h-[60px] md:min-h-[80px] text-xs md:text-sm italic bg-gray-50",children:h||"Tidak ada catatan."})]}),e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center md:items-start text-sm mt-8 gap-8 md:gap-0",children:[e.jsxs("div",{className:"text-center w-full md:w-64",children:[e.jsx("p",{className:"mb-16 md:mb-20",children:"Orang Tua/Wali"}),e.jsx("p",{children:"(___________________)"})]}),e.jsxs("div",{className:"text-center w-full md:w-64",children:[e.jsxs("p",{className:"mb-2",children:["Madiun, ",new Date(x).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})]}),e.jsx("p",{className:"mb-16 md:mb-20",children:"Wali Kelas"}),e.jsx("p",{className:"font-bold underline",children:n==null?void 0:n.name})]})]})]})}),e.jsx(re,{icon:e.jsx(I,{className:"w-6 h-6"}),onClick:A,className:"md:hidden fixed bottom-6 right-6 z-40 bg-purple-600 hover:bg-purple-700"})]})]}):null};export{ie as default};

import{u as Fe,g as ie,s as $,j as e,G as ma,X as ce,C as $e,a1 as pa,w as ha,ab as ga,o as xa,J as ba,I as q,B as W,S as fa,am as ja,q as wa,y as ka,b as Na,z as va,a8 as ya,a as _a,r as u,a9 as Sa,f as Ca,T as G,x as Ce}from"./index-D1C6o8KR.js";import{u as Pe}from"./useMutation-DEQ-bH50.js";import{v as Te}from"./violations.data-D8bejHRP.js";import{E as Me,a as Pa}from"./jspdf.plugin.autotable-Cos_-fnW.js";import{g as Ma}from"./pdfGenerator-DW_90Ppn.js";import{S as Q}from"./Select-D9Pc8JrA.js";import{C as xe}from"./Checkbox-DScJh7tZ.js";const Fa=(s,o,c,S)=>{const{user:w}=Fe(),{data:D,isLoading:J}=ie({queryKey:["classes",w==null?void 0:w.id],queryFn:async()=>{if(!w)return[];const{data:x,error:d}=await $.from("classes").select("*").eq("user_id",w.id).order("name");if(d)throw d;return x||[]},enabled:!!w}),{data:m,isLoading:l}=ie({queryKey:["studentsForMassInput",s],queryFn:async()=>{if(!s)return[];const{data:x,error:d}=await $.from("students").select("*").eq("class_id",s).order("name");if(d)throw d;return x||[]},enabled:!!s}),{data:_}=ie({queryKey:["distinctSubjects",w==null?void 0:w.id],queryFn:async()=>{if(!w)return[];const{data:x,error:d}=await $.from("academic_records").select("subject").eq("user_id",w.id);if(d)return console.error("Error fetching distinct subjects:",d),[];const r=(x||[]).map(k=>k.subject);return[...new Set(r)].sort()},enabled:!!w,staleTime:1e3*60*15}),{data:b}=ie({queryKey:["assessmentNames",s,o],queryFn:async()=>{if(!s||!o||!m)return[];const{data:x,error:d}=await $.from("academic_records").select("assessment_name").eq("subject",o).in("student_id",(m==null?void 0:m.map(k=>k.id))||[]);if(d)throw d;const r=(x||[]).map(k=>k.assessment_name).filter(k=>k!==null);return[...new Set(r)].sort()},enabled:S==="delete_subject_grade"&&!!s&&!!o&&!!m}),{data:M,isLoading:g}=ie({queryKey:["existingGrades",s,o,c],queryFn:async()=>{if(!s||!o||!c||!m)return[];const{data:x,error:d}=await $.from("academic_records").select("*").eq("subject",o).eq("assessment_name",c).in("student_id",(m==null?void 0:m.map(r=>r.id))||[]);if(d)throw d;return x||[]},enabled:!!s&&!!o&&!!c&&!!m&&(S==="subject_grade"||S==="delete_subject_grade")});return{classes:D,isLoadingClasses:J,studentsData:m,isLoadingStudents:l,uniqueSubjects:_,assessmentNames:b,existingGrades:M,isLoadingGrades:g}},be=[{mode:"subject_grade",title:"Input Nilai Mapel",description:"Masukkan nilai sumatif/akhir untuk satu kelas sekaligus.",icon:ma},{mode:"delete_subject_grade",title:"Hapus Nilai Massal",description:"Hapus data nilai untuk satu kelas dan penilaian tertentu.",icon:ce},{mode:"quiz",title:"Input Poin Keaktifan",description:"Beri poin untuk siswa yang aktif di kelas.",icon:$e},{mode:"violation",title:"Input Pelanggaran",description:"Catat poin pelanggaran untuk beberapa siswa.",icon:pa},{mode:"bulk_report",title:"Cetak Rapor Massal",description:"Cetak beberapa rapor dari satu kelas dalam satu file.",icon:ha},{mode:"academic_print",title:"Cetak Nilai Akademik",description:"Cetak rekap nilai per mata pelajaran untuk satu kelas.",icon:ga}],$a=({handleModeSelect:s})=>e.jsxs("div",{className:"w-full max-w-6xl mx-auto",children:[e.jsxs("header",{className:"text-center mb-12",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-20 h-20 bg-gradient-to-br from-purple-500/20 to-indigo-500/20 rounded-full flex items-center justify-center border border-white/10",children:e.jsx(xa,{className:"w-10 h-10 text-purple-300"})})}),e.jsx("h1",{className:"text-4xl font-bold text-white text-shadow-md",children:"Pusat Input Cerdas"}),e.jsx("p",{className:"mt-2 text-lg text-indigo-200",children:"Pilih aksi massal yang ingin Anda lakukan untuk efisiensi maksimal."})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:be.map((o,c)=>e.jsxs("div",{onClick:()=>s(o.mode),className:"step-card group bg-white/5 backdrop-blur-lg rounded-2xl p-5 sm:p-6 text-center transition-all duration-300 hover:-translate-y-2 cursor-pointer",style:{animationDelay:`${c*100}ms`},children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-purple-500/10 to-indigo-500/10 rounded-full flex items-center justify-center transition-transform group-hover:scale-110 border border-white/10 group-hover:border-purple-400/50",children:e.jsx(o.icon,{className:"w-8 h-8 text-purple-300 transition-colors group-hover:text-purple-200"})})}),e.jsx("h3",{className:"text-lg font-bold text-white",children:o.title}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:o.description})]},o.mode))})]}),Ta=({mode:s,isConfigOpen:o,setIsConfigOpen:c,selectedClass:S,setSelectedClass:w,classes:D,isLoadingClasses:J,quizInfo:m,setQuizInfo:l,subjectGradeInfo:_,setSubjectGradeInfo:b,isCustomSubject:M,setIsCustomSubject:g,uniqueSubjects:x,selectedViolationCode:d,setSelectedViolationCode:r,violationDate:k,setViolationDate:v,noteMethod:A,setNoteMethod:I,templateNote:z,setTemplateNote:ne,assessmentNames:K,pasteData:re,setPasteData:le,isParsing:Z,handleAiParse:p,isOnline:H})=>e.jsxs("div",{className:"lg:col-span-1 space-y-6",children:[e.jsxs("div",{className:"bg-white/5 backdrop-blur-lg rounded-2xl border border-white/10 overflow-hidden",children:[e.jsxs("div",{className:"p-4 sm:p-6 border-b border-white/10 flex justify-between items-center cursor-pointer lg:cursor-default",onClick:()=>window.innerWidth<1024&&c(!o),children:[e.jsx("h3",{className:"font-bold text-lg",children:"Konfigurasi"}),e.jsx(ba,{className:`w-5 h-5 lg:hidden transition-transform duration-200 ${o?"rotate-180":""}`})]}),e.jsx("div",{className:`p-4 sm:p-6 ${o?"block":"hidden lg:block"}`,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"class-select",className:"text-sm font-medium text-gray-300",children:"Kelas"}),e.jsx(Q,{id:"class-select",value:S,onChange:t=>w(t.target.value),disabled:J,children:D==null?void 0:D.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),s==="quiz"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"quiz-name",className:"text-sm font-medium text-gray-300",children:"Nama Aktivitas"}),e.jsx(q,{id:"quiz-name",value:m.name,onChange:t=>l(h=>({...h,name:t.target.value})),placeholder:"cth. Aktif Bertanya"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"quiz-subject",className:"text-sm font-medium text-gray-300",children:"Mata Pelajaran"}),M?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{id:"quiz-subject",value:m.subject,onChange:t=>l(h=>({...h,subject:t.target.value})),placeholder:"Ketik nama mapel baru...",autoFocus:!0,required:!0}),e.jsx(W,{variant:"outline",onClick:()=>{g(!1),l(t=>({...t,subject:""}))},title:"Kembali ke daftar",className:"px-3",children:e.jsx(ce,{className:"w-5 h-5"})})]}):e.jsxs(Q,{id:"quiz-subject",value:m.subject,onChange:t=>{t.target.value==="__NEW__"?(g(!0),l(h=>({...h,subject:""}))):l(h=>({...h,subject:t.target.value}))},required:!0,children:[e.jsx("option",{value:"",children:"-- Pilih Mapel --"}),x==null?void 0:x.map(t=>e.jsx("option",{value:t,children:t},t)),e.jsx("option",{value:"__NEW__",className:"font-bold text-purple-400 bg-purple-900/20",children:"+ Tambah Mapel Baru"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"quiz-date",className:"text-sm font-medium text-gray-300",children:"Tanggal"}),e.jsx(q,{id:"quiz-date",type:"date",value:m.date,onChange:t=>l(h=>({...h,date:t.target.value}))})]})]}),s==="subject_grade"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"grade-subject",className:"text-sm font-medium text-gray-300",children:"Mata Pelajaran"}),M?e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{id:"grade-subject",value:_.subject,onChange:t=>b(h=>({...h,subject:t.target.value})),placeholder:"Ketik nama mapel baru...",autoFocus:!0,required:!0}),e.jsx(W,{variant:"outline",onClick:()=>{g(!1),b(t=>({...t,subject:""}))},title:"Kembali ke daftar",className:"px-3",children:e.jsx(ce,{className:"w-5 h-5"})})]}):e.jsxs(Q,{id:"grade-subject",value:_.subject,onChange:t=>{t.target.value==="__NEW__"?(g(!0),b(h=>({...h,subject:""}))):b(h=>({...h,subject:t.target.value}))},required:!0,children:[e.jsx("option",{value:"",children:"-- Pilih Mapel --"}),x==null?void 0:x.map(t=>e.jsx("option",{value:t,children:t},t)),e.jsx("option",{value:"__NEW__",className:"font-bold text-purple-400 bg-purple-900/20",children:"+ Tambah Mapel Baru"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"assessment-name",className:"text-sm font-medium text-gray-300",children:"Nama Penilaian"}),e.jsx(q,{id:"assessment-name",value:_.assessment_name,onChange:t=>b(h=>({...h,assessment_name:t.target.value})),placeholder:"cth. PH 1, UTS",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"grade-notes",className:"text-sm font-medium text-gray-300",children:"Catatan (Opsional)"}),e.jsx(q,{id:"grade-notes",value:_.notes,onChange:t=>b(h=>({...h,notes:t.target.value})),placeholder:"Catatan umum untuk semua nilai"})]})]}),s==="violation"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"violation-type",className:"text-sm font-medium text-gray-300",children:"Jenis Pelanggaran"}),e.jsxs(Q,{id:"violation-type",value:d,onChange:t=>r(t.target.value),children:[e.jsx("option",{value:"",children:"-- Pilih Pelanggaran --"}),Te.map(t=>e.jsxs("option",{value:t.code,children:[t.description," (",t.points," poin)"]},t.code))]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"violation-date",className:"text-sm font-medium text-gray-300",children:"Tanggal"}),e.jsx(q,{id:"violation-date",type:"date",value:k,onChange:t=>v(t.target.value)})]})]}),s==="bulk_report"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"note-method",className:"text-sm font-medium text-gray-300",children:"Metode Catatan Guru"}),e.jsxs(Q,{id:"note-method",value:A,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"ai",children:"Generate dengan AI"}),e.jsx("option",{value:"template",children:"Gunakan Template"})]})]}),A==="template"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"template-note",className:"text-sm font-medium text-gray-300",children:"Template Catatan"}),e.jsx("textarea",{id:"template-note",value:z,onChange:t=>ne(t.target.value),rows:4,className:"w-full mt-1 p-2 border rounded-md bg-white/10 border-white/20 text-white placeholder:text-gray-400"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Gunakan [Nama Siswa] untuk personalisasi."})]})]}),s==="academic_print"&&e.jsxs("div",{children:[e.jsx("label",{htmlFor:"print-subject",className:"text-sm font-medium text-gray-300",children:"Mata Pelajaran"}),e.jsx(q,{id:"print-subject",list:"subjects-datalist",value:_.subject,onChange:t=>b(h=>({...h,subject:t.target.value})),placeholder:"Pilih atau ketik mapel"}),e.jsx("datalist",{id:"subjects-datalist",children:x==null?void 0:x.map(t=>e.jsx("option",{value:t},t))})]}),s==="delete_subject_grade"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"delete-subject",className:"text-sm font-medium text-gray-300",children:"Mata Pelajaran"}),e.jsx(q,{id:"delete-subject",list:"subjects-datalist",value:_.subject,onChange:t=>b(h=>({...h,subject:t.target.value,assessment_name:""})),placeholder:"Pilih atau ketik mapel",required:!0}),e.jsx("datalist",{id:"subjects-datalist",children:x==null?void 0:x.map(t=>e.jsx("option",{value:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"delete-assessment",className:"text-sm font-medium text-gray-300",children:"Nama Penilaian"}),e.jsxs(Q,{id:"delete-assessment",value:_.assessment_name,onChange:t=>b(h=>({...h,assessment_name:t.target.value})),disabled:!_.subject||!K,required:!0,children:[e.jsx("option",{value:"",children:"-- Pilih Penilaian --"}),K==null?void 0:K.map(t=>e.jsx("option",{value:t,children:t},t))]})]})]})]})})]}),s==="subject_grade"&&H&&e.jsxs("div",{className:"bg-white/5 backdrop-blur-lg rounded-2xl border border-white/10 p-6",children:[e.jsxs("h3",{className:"font-bold text-lg mb-4 border-b border-white/10 pb-3 flex items-center gap-2",children:[e.jsx(fa,{className:"w-5 h-5 text-purple-400"}),"Tempel Data Nilai"]}),e.jsx("textarea",{value:re,onChange:t=>le(t.target.value),placeholder:`Contoh:
Budi Santoso   95
Ani Wijaya      88`,rows:4,className:"w-full p-2 border rounded-md bg-white/10 border-white/20 text-white placeholder:text-gray-400"}),e.jsxs(W,{onClick:p,disabled:Z,className:"mt-2",children:[e.jsx(ja,{className:"w-4 h-4 mr-2"}),Z?"Memproses...":"Proses dengan AI"]})]})]}),Aa=({options:s,currentValue:o,onFilterChange:c})=>e.jsx("div",{className:"flex items-center gap-2",children:s.map(({value:S,label:w})=>e.jsx("button",{onClick:()=>c(S),className:`px-3 py-1 text-xs font-semibold rounded-full transition-colors ${o===S?"bg-purple-500 text-white":"bg-white/10 text-gray-300 hover:bg-white/20"}`,children:w},S))}),Da=({mode:s,searchTerm:o,setSearchTerm:c,filterOptions:S,studentFilter:w,setStudentFilter:D,isLoadingStudents:J,students:m,isAllSelected:l,handleSelectAllStudents:_,selectedStudentIds:b,handleStudentSelect:M,scores:g,handleScoreChange:x,existingGrades:d})=>e.jsxs("div",{className:"lg:col-span-2 bg-white/5 backdrop-blur-lg rounded-2xl border border-white/10 flex flex-col",children:[e.jsxs("div",{className:"p-4 sm:p-6 border-b border-white/10 flex-shrink-0 flex flex-col sm:flex-row items-start sm:items-center gap-4 justify-between",children:[e.jsxs("div",{className:"relative flex-grow w-full sm:w-auto",children:[e.jsx(wa,{className:"w-5 h-5 text-gray-400 absolute top-1/2 left-3 -translate-y-1/2"}),e.jsx(q,{value:o,onChange:r=>c(r.target.value),placeholder:"Cari nama siswa...",className:"pl-10 w-full"})]}),e.jsx(Aa,{options:S,currentValue:w,onFilterChange:D})]}),e.jsx("div",{className:"flex-grow overflow-y-auto p-4",children:J?e.jsx("p",{className:"p-6 text-center",children:"Memuat siswa..."}):m&&m.length>0?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden md:block overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm striped-table sticky-header",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-4 text-left w-10",children:s!=="subject_grade"&&e.jsx(xe,{checked:l,onChange:r=>_(r.target.checked)})}),e.jsx("th",{className:"p-4 text-left font-semibold",children:"Nama Siswa"}),e.jsx("th",{className:"p-4 text-left font-semibold",children:s==="subject_grade"?"Input Nilai":s==="academic_print"||s==="delete_subject_grade"?"Nilai Saat Ini":"Status"})]})}),e.jsx("tbody",{children:m.map(r=>{var I;const k=b.has(r.id),v=s==="delete_subject_grade"||s==="academic_print"?(d||[]).find(z=>z.student_id===r.id):null,A=!!v;return e.jsxs("tr",{onClick:s!=="subject_grade"?()=>M(r.id):void 0,className:`border-b border-white/10 transition-colors ${k||s==="subject_grade"&&((I=g[r.id])!=null&&I.trim())?"bg-purple-500/10":"hover:bg-white/5"} ${s!=="subject_grade"?"cursor-pointer":""}`,children:[e.jsx("td",{className:"p-4",children:s!=="subject_grade"&&e.jsx(xe,{checked:k,onChange:()=>M(r.id),disabled:s==="delete_subject_grade"&&!A})}),e.jsxs("td",{className:"p-4 flex items-center gap-3",children:[e.jsx("img",{src:r.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(r.name)}&background=random`,alt:r.name,className:"w-10 h-10 rounded-full object-cover ring-2 ring-white/10"}),e.jsx("span",{className:"font-medium",children:r.name})]}),e.jsx("td",{className:"p-4",children:s==="subject_grade"?e.jsx(q,{type:"number",inputMode:"numeric",min:"0",max:"100",value:g[r.id]||"",onChange:z=>x(r.id,z.target.value),placeholder:"0-100",className:"w-28"}):s==="academic_print"||s==="delete_subject_grade"?e.jsx("span",{className:`font-bold px-3 py-1.5 rounded-lg ${A?"bg-purple-500/20 text-purple-200":"bg-white/10 text-gray-500"}`,children:A?v==null?void 0:v.score:"N/A"}):k?e.jsx("span",{className:"text-green-400 font-semibold",children:"Terpilih"}):e.jsx("span",{className:"text-gray-500",children:"Belum dipilih"})})]},r.id)})})]})}),e.jsx("div",{className:"md:hidden space-y-3",children:m.map(r=>{var I;const k=b.has(r.id),v=s==="delete_subject_grade"||s==="academic_print"?(d||[]).find(z=>z.student_id===r.id):null,A=!!v;return e.jsxs("div",{onClick:s!=="subject_grade"?()=>M(r.id):void 0,className:`bg-white/5 backdrop-blur-sm rounded-xl border transition-all duration-200 ${k||s==="subject_grade"&&((I=g[r.id])!=null&&I.trim())?"border-purple-500/50 bg-purple-500/10 shadow-lg shadow-purple-500/20":"border-white/10 hover:border-white/20"} ${s!=="subject_grade"?"cursor-pointer active:scale-98":""} p-4`,children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[s!=="subject_grade"&&e.jsx(xe,{checked:k,onChange:()=>M(r.id),disabled:s==="delete_subject_grade"&&!A}),e.jsx("img",{src:r.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(r.name)}&background=random`,alt:r.name,className:"w-12 h-12 rounded-full object-cover ring-2 ring-white/20 shadow-md"}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"font-semibold text-white text-base leading-tight",children:r.name}),e.jsxs("p",{className:"text-xs text-gray-400 mt-0.5",children:["No. ",m.indexOf(r)+1]})]})]}),s==="subject_grade"?e.jsxs("div",{className:"flex items-center gap-3 mt-3 pt-3 border-t border-white/10",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300 min-w-[60px]",children:"Nilai:"}),e.jsx(q,{type:"number",inputMode:"numeric",min:"0",max:"100",value:g[r.id]||"",onChange:z=>x(r.id,z.target.value),placeholder:"0-100",className:"flex-grow text-lg font-semibold text-center"}),g[r.id]&&e.jsx("span",{className:`px-3 py-1.5 rounded-lg text-sm font-bold ${parseInt(g[r.id])>=75?"bg-green-500/20 text-green-300":parseInt(g[r.id])>=60?"bg-yellow-500/20 text-yellow-300":"bg-red-500/20 text-red-300"}`,children:parseInt(g[r.id])>=75?"Baik":parseInt(g[r.id])>=60?"Cukup":"Kurang"})]}):s==="academic_print"||s==="delete_subject_grade"?e.jsxs("div",{className:"flex items-center justify-between mt-3 pt-3 border-t border-white/10",children:[e.jsx("span",{className:"text-sm text-gray-400",children:"Nilai Saat Ini:"}),e.jsx("span",{className:`font-bold px-3 py-1.5 rounded-lg text-lg ${A?"bg-purple-500/20 text-purple-200":"bg-white/10 text-gray-500"}`,children:A?v==null?void 0:v.score:"N/A"})]}):e.jsxs("div",{className:"flex items-center justify-between mt-3 pt-3 border-t border-white/10",children:[e.jsx("span",{className:"text-sm text-gray-400",children:"Status:"}),k?e.jsxs("span",{className:"text-green-400 font-semibold flex items-center gap-1",children:[e.jsx($e,{className:"w-4 h-4"}),"Terpilih"]}):e.jsx("span",{className:"text-gray-500",children:"Belum dipilih"})]})]},r.id)})})]}):e.jsx("p",{className:"p-6 text-center",children:"Tidak ada siswa di kelas ini atau tidak ada hasil pencarian."})})]}),qa=({summaryText:s,mode:o,selectedStudentIds:c,gradedCount:S,setScores:w,setSelectedStudentIds:D,isExporting:J,exportProgress:m,handleSubmit:l,isSubmitDisabled:_,submitButtonTooltip:b,isSubmitting:M,isDeleting:g})=>e.jsx("footer",{className:"sticky bottom-0 -mx-4 -mb-4 sm:-mx-6 sm:-mb-6 md:-mx-8 md:-mb-8 mt-6 z-20",children:e.jsxs("div",{className:"bg-gray-950/70 backdrop-blur-lg border-t border-white/10 p-4 flex flex-col sm:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("p",{className:"text-sm text-gray-300",children:s}),o!=="subject_grade"&&c.size>0||o==="subject_grade"&&S>0?e.jsxs(W,{variant:"ghost",size:"sm",onClick:()=>o==="subject_grade"?w({}):D(new Set),children:[e.jsx(ce,{className:"w-4 h-4 mr-1"})," Bersihkan"]}):null]}),J?e.jsx("div",{className:"w-full sm:w-64 text-center",children:e.jsxs("div",{className:"relative pt-1",children:[e.jsx("div",{className:"overflow-hidden h-2 mb-2 text-xs flex rounded bg-purple-200/20",children:e.jsx("div",{style:{width:m},className:"shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-500"})}),e.jsx("p",{className:"text-xs text-purple-200",children:m})]})}):e.jsx(W,{onClick:l,disabled:_,title:b,className:"w-full sm:w-auto",variant:o==="delete_subject_grade"?"destructive":"default",children:M||g?"Memproses...":o==="delete_subject_grade"?"Hapus Nilai Terpilih":o!=null&&o.includes("print")||o!=null&&o.includes("report")?"Cetak Laporan":"Simpan Data"})]})}),Ja=()=>{var ve,ye,_e;const{user:s}=Fe(),o=ka(),c=Na(),S=va(),w=ya(),D=_a(),[J,m]=u.useState(1),[l,_]=u.useState(null),[b,M]=u.useState(""),[g,x]=u.useState({name:"",subject:"",date:new Date().toISOString().slice(0,10)}),[d,r]=u.useState({subject:"",assessment_name:"",notes:""}),[k,v]=u.useState({}),[A,I]=u.useState(""),[z,ne]=u.useState(!1),[K,re]=u.useState(""),[le,Z]=u.useState(new Date().toISOString().slice(0,10)),[p,H]=u.useState(new Set),[t,h]=u.useState(""),[V,de]=u.useState("all"),[ue,oe]=u.useState(!1),[Ae,ee]=u.useState("0%"),[fe,De]=u.useState("ai"),[je,qe]=u.useState("Ananda [Nama Siswa] menunjukkan perkembangan yang baik semester ini. Terus tingkatkan semangat belajar dan jangan ragu bertanya jika ada kesulitan."),[we,ae]=u.useState({isOpen:!1,count:0}),[ke,ze]=u.useState({}),[Ee,Re]=u.useState(!0),[Oe,me]=u.useState(!1),{classes:E,isLoadingClasses:Ie,studentsData:N,isLoadingStudents:Ke,uniqueSubjects:Be,assessmentNames:Le,existingGrades:B}=Fa(b,d.subject,d.assessment_name,l||void 0);u.useEffect(()=>{var i;const a=(i=w.state)==null?void 0:i.prefill;if(a){const{mode:n,classId:f,subject:F,assessment_name:C}=a;n&&(_(n),m(2)),f&&M(f),(F||C)&&r(j=>({...j,subject:F||j.subject,assessment_name:C||j.assessment_name})),D(w.pathname,{replace:!0,state:{}})}},[(ve=w.state)==null?void 0:ve.prefill,D]),u.useEffect(()=>{E&&E.length>0&&!b&&M(E[0].id)},[E,b]),u.useEffect(()=>{if(l==="subject_grade"&&B){const a=B.reduce((i,n)=>(i[n.student_id]=String(n.score),i),{});v(a)}else l!=="subject_grade"&&v(a=>Object.keys(a).length===0?a:{})},[B,l]);const U=u.useMemo(()=>new Set(B==null?void 0:B.map(a=>a.student_id)),[B]),Je=u.useMemo(()=>{if(!N)return[];let a=N;return l==="subject_grade"||l==="delete_subject_grade"?V==="graded"?a=a.filter(i=>U.has(i.id)):V==="ungraded"&&(a=a.filter(i=>!U.has(i.id))):l&&(V==="selected"?a=a.filter(i=>p.has(i.id)):V==="unselected"&&(a=a.filter(i=>!p.has(i.id)))),t&&(a=a.filter(i=>i.name.toLowerCase().includes(t.toLowerCase()))),a},[N,t,V,U,p,l]),He=a=>{_(a),m(2),me(!1)},Ge=()=>{m(1),_(null),M(""),x({name:"",subject:"",date:new Date().toISOString().slice(0,10)}),r({subject:"",assessment_name:"",notes:""}),v({}),I(""),re(""),Z(new Date().toISOString().slice(0,10)),H(new Set),h(""),de("all"),ae({isOpen:!1,count:0}),me(!1)};u.useEffect(()=>{H(new Set),v({}),h(""),de("all")},[b]),u.useEffect(()=>{de("all")},[l]);const Y=u.useMemo(()=>Object.values(k).filter(a=>a&&a.trim()!=="").length,[k]),pe=u.useMemo(()=>N?l==="delete_subject_grade"?N.filter(a=>U.has(a.id)).length:N.length:0,[N,l,U]),Ue=u.useMemo(()=>pe===0?!1:p.size===pe,[p.size,pe]),he=u.useMemo(()=>Te.find(a=>a.code===K)||null,[K]),We=a=>{if(a){if(!N)return;let i=N.map(n=>n.id);l==="delete_subject_grade"&&(i=N.filter(n=>U.has(n.id)).map(n=>n.id)),H(new Set(i))}else H(new Set)},Ve=a=>{H(i=>{const n=new Set(i);return n.has(a)?n.delete(a):n.add(a),n})},Ye=(a,i)=>{const n=Number(i),f={...ke};i&&(isNaN(n)||n<0||n>100)?f[a]="Nilai harus antara 0-100":delete f[a],ze(f),v(F=>({...F,[a]:i}))},{mutate:Xe,isPending:ge}=Pe({mutationFn:async()=>{if(!l||!s)throw new Error("Mode atau pengguna tidak diatur");switch(l){case"quiz":{if(!g.name||!g.subject||p.size===0)throw new Error("Informasi aktivitas dan siswa harus diisi.");const a=Array.from(p).map(n=>({quiz_name:g.name,subject:g.subject,quiz_date:g.date,student_id:n,user_id:s.id,points:1,max_points:1})),{error:i}=await $.from("quiz_points").insert(a);if(i)throw i;return`Poin keaktifan untuk ${a.length} siswa berhasil disimpan.`}case"subject_grade":{if(!d.subject||!d.assessment_name||Y===0)throw new Error("Mata pelajaran, nama penilaian, dan setidaknya satu nilai harus diisi.");if(Object.keys(ke).length>0)throw new Error("Perbaiki nilai yang tidak valid sebelum menyimpan.");const a=new Map((B||[]).map(f=>[f.student_id,f.id])),i=Object.entries(k).filter(([,f])=>f&&f.trim()!=="").map(([f,F])=>{const C=Number(F);if(C<0||C>100)throw new Error(`Nilai untuk siswa tidak valid: ${C}. Harus antara 0-100.`);return{id:a.get(f)||crypto.randomUUID(),subject:d.subject,assessment_name:d.assessment_name,notes:d.notes,score:C,student_id:f,user_id:s.id}}),{error:n}=await $.from("academic_records").upsert(i);if(n)throw n;return`Nilai untuk ${i.length} siswa berhasil disimpan.`}case"violation":{if(!he||p.size===0)throw new Error("Jenis pelanggaran dan siswa harus dipilih.");const a=Array.from(p).map(n=>({date:le,description:he.description,points:he.points,student_id:n,user_id:s.id})),{error:i}=await $.from("violations").insert(a);if(i)throw i;return`Pelanggaran untuk ${a.length} siswa berhasil dicatat.`}}},onSuccess:a=>{c.success(a||"Data berhasil disimpan!"),o.invalidateQueries({queryKey:["studentDetails"]})},onError:a=>c.error(`Gagal menyimpan: ${a.message}`)}),{mutate:Qe,isPending:te}=Pe({mutationFn:async a=>{if(a.length===0)return"Tidak ada nilai yang dipilih untuk dihapus.";const{error:i}=await $.from("academic_records").delete().in("id",a);if(i)throw i;return`${a.length} data nilai berhasil dihapus.`},onSuccess:a=>{c.success(a),o.invalidateQueries({queryKey:["existingGrades"]}),H(new Set)},onError:a=>c.error(`Gagal menghapus: ${a.message}`)}),Ze=async()=>{if(!N||N.length===0){c.warning("Pilih kelas dengan siswa terlebih dahulu.");return}if(!A.trim()){c.warning("Tempelkan data nilai terlebih dahulu.");return}ne(!0);try{const a=N.map(P=>P.name),i="Anda adalah asisten entri data. Tugas Anda adalah mencocokkan nama dari teks yang diberikan dengan daftar nama siswa yang ada dan mengekstrak nilainya. Hanya cocokkan nama yang ada di daftar. Abaikan nama yang tidak ada di daftar. Format output harus JSON yang valid sesuai skema.",n=`Daftar Siswa: ${JSON.stringify(a)}

Teks Nilai untuk Diproses:
${A}`,f={type:G.ARRAY,items:{type:G.OBJECT,properties:{studentName:{type:G.STRING},score:{type:G.STRING}}}},C=(await Ce.models.generateContent({model:"gemini-2.5-flash",contents:n,config:{systemInstruction:i,responseMimeType:"application/json",responseSchema:f}})).text||"[]",j=JSON.parse(C.trim()),y={};let R=0;j.forEach(P=>{const X=N.find(L=>L.name.toLowerCase()===P.studentName.toLowerCase());X&&(y[X.id]=String(P.score),R++)}),v(P=>({...P,...y})),c.success(`${R} dari ${j.length} nilai berhasil dicocokkan dan diisi.`)}catch(a){console.error("AI Parsing Error:",a),c.error("Gagal memproses data. Pastikan format teks benar.")}finally{ne(!1)}},ea=async(a,i)=>{const n=await $.from("students").select("*, classes(id, name)").eq("id",a).eq("user_id",i).single();if(n.error)throw new Error(n.error.message);const[f,F,C,j,y]=await Promise.all([$.from("reports").select("*").eq("student_id",a),$.from("attendance").select("*").eq("student_id",a),$.from("academic_records").select("*").eq("student_id",a),$.from("violations").select("*").eq("student_id",a),$.from("quiz_points").select("*").eq("student_id",a)]),R=[f,F,C,j,y].map(P=>P.error).filter(P=>P!==null);if(R.length>0)throw new Error(R.map(P=>P.message).join(", "));return{student:n.data,reports:f.data||[],attendanceRecords:F.data||[],academicRecords:C.data||[],violations:j.data||[],quizPoints:y.data||[]}},aa=async()=>{var i;if(p.size===0){c.warning("Pilih setidaknya satu siswa.");return}if(!N)return;oe(!0),ee("0%"),c.info(`Mulai proses cetak ${p.size} rapor...`);const a=N.filter(n=>p.has(n.id));try{ee("10%"),c.info("Mengambil data siswa...");const n=await Promise.all(a.map(j=>ea(j.id,s.id)));ee("40%"),c.info("Membuat catatan guru...");let f;if(fe==="template")f=new Map(n.map(j=>[j.student.id,je.replace(/\[Nama Siswa\]/g,j.student.name)]));else{const j=n.map(T=>{var Se;const oa=T.academicRecords.length>0?`Nilai rata-rata: ${Math.round(T.academicRecords.reduce((O,se)=>O+se.score,0)/T.academicRecords.length)}. Pelajaran terbaik: ${((Se=[...T.academicRecords].sort((O,se)=>se.score-O.score)[0])==null?void 0:Se.subject)||"N/A"}.`:"Belum ada data nilai.",ca=T.violations.length>0?`${T.violations.length} pelanggaran dengan total ${T.violations.reduce((O,se)=>O+se.points,0)} poin.`:"Perilaku baik, tidak ada pelanggaran.",ua=`Sakit: ${T.attendanceRecords.filter(O=>O.status==="Sakit").length}, Izin: ${T.attendanceRecords.filter(O=>O.status==="Izin").length}, Alpha: ${T.attendanceRecords.filter(O=>O.status==="Alpha").length}.`;return{studentId:T.student.id,studentName:T.student.name,academicSummary:oa,behaviorSummary:ca,attendanceSummary:ua}}),y='Anda adalah seorang guru wali kelas yang bijaksana dan suportif. Tugas Anda adalah menulis paragraf "Catatan Wali Kelas" untuk setiap siswa berdasarkan data yang diberikan. Catatan harus holistik, memotivasi, dan dalam satu paragraf (3-5 kalimat). Jawab dalam format JSON array yang diminta.',R=`Buatkan "Catatan Wali Kelas" untuk setiap siswa dalam daftar JSON berikut. Data Siswa: ${JSON.stringify(j)}`,P={type:G.OBJECT,properties:{notes:{type:G.ARRAY,items:{type:G.OBJECT,properties:{studentId:{type:G.STRING},teacherNote:{type:G.STRING}},required:["studentId","teacherNote"]}}},required:["notes"]},L=(await Ce.models.generateContent({model:"gemini-2.5-flash",contents:R,config:{systemInstruction:y,responseMimeType:"application/json",responseSchema:P}})).text||'{"notes": []}',da=JSON.parse(L).notes;f=new Map(da.map(T=>[T.studentId,T.teacherNote.replace(/\\n/g," ")]))}ee("70%"),c.info("Menyusun file PDF...");const F=new Me({orientation:"portrait",unit:"mm",format:"a4"});let C=!0;for(let j=0;j<n.length;j++){const y=n[j],R=f.get(y.student.id)||"Catatan tidak dapat dibuat.";C||F.addPage(),C=!1,Ma(F,y,R,new Date().toISOString().slice(0,10),"Ganjil",`${new Date().getFullYear()} / ${new Date().getFullYear()+1}`,s),ee(`${Math.round(70+(j+1)/a.length*30)}%`)}F.save(`Rapor_Massal_${((i=E==null?void 0:E.find(j=>j.id===b))==null?void 0:i.name)||"Kelas"}.pdf`),c.success("Semua rapor terpilih berhasil digabung dalam satu PDF!")}catch(n){console.error("Gagal membuat rapor massal:",n),c.error(`Gagal membuat rapor massal: ${n instanceof Error?n.message:"Unknown error"}`)}finally{oe(!1)}},ta=async()=>{var j;if(!b||!d.subject){c.warning("Pilih kelas dan mata pelajaran.");return}if(p.size===0){c.warning("Pilih setidaknya satu siswa untuk mencetak.");return}oe(!0),c.info("Membuat rekap nilai...");const a=new Me,i=(j=E==null?void 0:E.find(y=>y.id===b))==null?void 0:j.name;a.setFontSize(14),a.setFont("helvetica","bold"),a.text(`Rekap Nilai: ${d.subject}`,14,22),a.setFontSize(12),a.setFont("helvetica","normal"),a.text(`Kelas: ${i}`,14,30),a.text(`Tanggal Cetak: ${new Date().toLocaleDateString("id-ID")}`,14,38);const{data:n}=await $.from("academic_records").select("*").eq("subject",d.subject).in("student_id",Array.from(p)),f=[...new Set(n==null?void 0:n.map(y=>y.assessment_name||"Lainnya"))].sort(),F=[["No","Nama Siswa",...f]],C=(N||[]).filter(y=>p.has(y.id)).map((y,R)=>{const P={};(n||[]).filter(L=>L.student_id===y.id).forEach(L=>{P[L.assessment_name||"Lainnya"]=L.score});const X=[R+1,y.name];return f.forEach(L=>{X.push(P[L]??"N/A")}),X});Pa(a,{startY:45,head:F,body:C,theme:"grid",headStyles:{fillColor:"#0284c7"}}),a.save(`Nilai_${d.subject.replace(/\s/g,"_")}_${i}.pdf`),c.success("Rekap nilai berhasil diunduh."),oe(!1)},sa=()=>{const a=(B||[]).filter(i=>p.has(i.student_id)).map(i=>i.id);Qe(a),ae({isOpen:!1,count:0})},ia=()=>{l==="bulk_report"?aa():l==="academic_print"?ta():l==="delete_subject_grade"?ae({isOpen:!0,count:p.size}):Xe()},na=u.useMemo(()=>{const a=(N==null?void 0:N.length)||0;return l==="subject_grade"?`${Y} dari ${a} siswa telah dinilai.`:l==="delete_subject_grade"?`${p.size} dari ${U.size} siswa terpilih untuk dihapus.`:`${p.size} dari ${a} siswa dipilih.`},[l,Y,p.size,N,U]),Ne=u.useMemo(()=>{if(!S)return"Fitur ini memerlukan koneksi internet.";if(ge||ue||te)return"Sedang memproses...";if(!b)return"Pilih kelas terlebih dahulu.";switch(l){case"subject_grade":if(!d.subject||!d.assessment_name)return"Lengkapi mata pelajaran dan nama penilaian.";if(Y===0)return"Masukkan setidaknya satu nilai siswa.";break;case"quiz":if(!g.name||!g.subject)return"Lengkapi nama dan mata pelajaran aktivitas.";if(p.size===0)return"Pilih setidaknya satu siswa.";break;case"violation":if(!K)return"Pilih jenis pelanggaran.";if(p.size===0)return"Pilih setidaknya satu siswa.";break;case"delete_subject_grade":if(!d.subject||!d.assessment_name)return"Pilih mata pelajaran dan penilaian.";if(p.size===0)return"Pilih setidaknya satu nilai siswa untuk dihapus.";break;case"bulk_report":case"academic_print":if(p.size===0)return"Pilih setidaknya satu siswa.";if(l==="academic_print"&&!d.subject)return"Pilih mata pelajaran untuk dicetak.";break}return""},[S,ge,ue,te,b,l,d,Y,g,p,K]),ra=!!Ne,la=u.useMemo(()=>l==="subject_grade"||l==="delete_subject_grade"?[{value:"all",label:"Semua"},{value:"graded",label:"Sudah Dinilai"},{value:"ungraded",label:"Belum Dinilai"}]:["quiz","violation","bulk_report","academic_print"].includes(l||"")?[{value:"all",label:"Semua"},{value:"selected",label:"Terpilih"},{value:"unselected",label:"Belum Dipilih"}]:[],[l]);return e.jsx("div",{className:"w-full min-h-screen p-4 sm:p-6 md:p-8 pb-24 flex flex-col cosmic-bg text-white overflow-y-auto",children:J===1?e.jsx($a,{handleModeSelect:He}):e.jsxs("div",{className:"w-full max-w-7xl mx-auto flex flex-col flex-grow",children:[e.jsxs("header",{className:"flex items-center gap-4 mb-6",children:[e.jsx(W,{variant:"outline",size:"icon",onClick:Ge,className:"bg-white/10 border-white/20 hover:bg-white/20 flex-shrink-0",children:e.jsx(Sa,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:(ye=be.find(a=>a.mode===l))==null?void 0:ye.title}),e.jsx("p",{className:"mt-1 text-gray-300",children:(_e=be.find(a=>a.mode===l))==null?void 0:_e.description})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 flex-grow",children:[e.jsx(Ta,{mode:l,isConfigOpen:Ee,setIsConfigOpen:Re,selectedClass:b,setSelectedClass:M,classes:E,isLoadingClasses:Ie,quizInfo:g,setQuizInfo:x,subjectGradeInfo:d,setSubjectGradeInfo:r,isCustomSubject:Oe,setIsCustomSubject:me,uniqueSubjects:Be,selectedViolationCode:K,setSelectedViolationCode:re,violationDate:le,setViolationDate:Z,noteMethod:fe,setNoteMethod:De,templateNote:je,setTemplateNote:qe,assessmentNames:Le,pasteData:A,setPasteData:I,isParsing:z,handleAiParse:Ze,isOnline:S}),e.jsx(Da,{mode:l,searchTerm:t,setSearchTerm:h,filterOptions:la,studentFilter:V,setStudentFilter:de,isLoadingStudents:Ke,students:Je,isAllSelected:Ue,handleSelectAllStudents:We,selectedStudentIds:p,handleStudentSelect:Ve,scores:k,handleScoreChange:Ye,existingGrades:B})]}),e.jsx(Ca,{isOpen:we.isOpen,onClose:()=>ae({isOpen:!1,count:0}),title:"Konfirmasi Hapus Nilai",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-gray-600 dark:text-gray-400",children:["Anda akan menghapus ",e.jsxs("strong",{className:"text-white",children:[we.count," data nilai"]})," untuk penilaian ",e.jsxs("strong",{className:"text-white",children:['"',d.assessment_name,'"']}),". Aksi ini tidak dapat dibatalkan."]}),e.jsxs("div",{className:"pt-3 border-t border-gray-200 dark:border-gray-700",children:[e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400 mb-3",children:["Ketik ",e.jsx("strong",{className:"text-red-500",children:"HAPUS"})," untuk mengonfirmasi:"]}),e.jsx("input",{type:"text",id:"delete-confirm-input",placeholder:"Ketik HAPUS",className:"w-full px-3 py-2 text-sm border rounded-md mb-3 bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-gray-100"})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2",children:[e.jsx(W,{type:"button",variant:"ghost",onClick:()=>ae({isOpen:!1,count:0}),children:"Batal"}),e.jsx(W,{type:"button",variant:"destructive",onClick:()=>{const a=document.getElementById("delete-confirm-input");a&&a.value==="HAPUS"?sa():c.error("Konfirmasi tidak valid. Ketik HAPUS dengan benar.")},disabled:te,children:te?"Menghapus...":"Ya, Hapus"})]})]})}),e.jsx(qa,{summaryText:na,mode:l,selectedStudentIds:p,gradedCount:Y,setScores:v,setSelectedStudentIds:H,isExporting:ue,exportProgress:Ae,handleSubmit:ia,isSubmitDisabled:ra,submitButtonTooltip:Ne,isSubmitting:ge,isDeleting:te})]})})};export{Ja as default};

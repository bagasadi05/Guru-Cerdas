import{a7 as R,a as E,g as T,r as u,j as e,a0 as M,n as I,i as $,a1 as K,S as z,G as L,B as x,ao as q,b as B,y as A,s as N,K as F,Y as G,U as H,I as Q,a3 as U,f as D}from"./index-D1C6o8KR.js";import{u as P}from"./useMutation-DEQ-bH50.js";import{T as V,a as O,b as S,c as C}from"./Tabs-46UBlh0T.js";const Y=async(n,r)=>{const{data:l,error:t}=await N.rpc("get_student_portal_data",{student_id_param:n,access_code_param:r});if(t)throw console.error("Portal access RPC failed:",t),new Error(`Gagal memuat data portal: ${t.message}. Pastikan fungsi RPC 'get_student_portal_data' di Supabase sudah dikonfigurasi dengan benar, termasuk hak akses (RLS/SECURITY DEFINER).`);if(!l||l.length===0)throw new Error("Akses ditolak. Kode akses mungkin tidak valid untuk siswa ini atau telah kedaluwarsa.");const i=l[0];return{student:{...i.student,access_code:r},reports:i.reports||[],attendanceRecords:i.attendanceRecords||[],academicRecords:i.academicRecords||[],violations:i.violations||[],quizPoints:i.quizPoints||[],communications:i.communications||[],teacher:i.teacher}},J=({className:n,...r})=>e.jsx("div",{className:`bg-white/5 backdrop-blur-lg border border-white/10 rounded-2xl shadow-lg shadow-black/20 ${n}`,...r}),W=({student:n,onLogout:r})=>e.jsx("header",{className:"p-4 sm:p-6 sticky top-0 z-20 bg-gray-950/70 backdrop-blur-md border-b border-white/10",children:e.jsxs("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center",children:e.jsx(L,{className:"w-6 h-6 text-purple-300"})}),e.jsx("h1",{className:"text-xl font-bold tracking-wider hidden sm:block",children:"Portal Siswa"})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-right",children:n.name}),e.jsxs("p",{className:"text-sm text-gray-400 text-right",children:["Kelas ",n.classes.name]})]}),e.jsx("img",{src:n.avatar_url,alt:n.name,className:"w-12 h-12 rounded-full object-cover border-2 border-white/10"}),e.jsx(x,{variant:"ghost",size:"icon",onClick:r,"aria-label":"Logout",children:e.jsx(q,{className:"w-5 h-5"})})]})]})}),y=({icon:n,label:r,value:l,colorClass:t})=>e.jsxs("div",{className:`relative p-5 rounded-2xl overflow-hidden bg-white/5 border border-white/10 transition-all duration-300 hover:-translate-y-1 hover:shadow-2xl ${t.replace("bg-gradient-to-br","hover:shadow-purple-500/30")}`,children:[e.jsx("div",{className:`absolute -top-4 -right-4 w-20 h-20 rounded-full opacity-10 ${t.replace("from-","bg-")}`}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:`w-12 h-12 rounded-xl mb-4 flex items-center justify-center ${t}`,children:e.jsx(n,{className:"w-6 h-6 text-white"})}),e.jsx("p",{className:"text-3xl font-bold text-white",children:l}),e.jsx("p",{className:"text-sm text-gray-300 mt-1",children:r})]})]}),X=({communications:n,student:r,teacher:l})=>{const t=B(),i=A(),[h,p]=u.useState(""),[m,d]=u.useState({type:"closed",data:null}),j=u.useRef(null),{mutate:v,isPending:g}=P({mutationFn:async a=>{if(!r.access_code||!l)throw new Error("Informasi tidak lengkap untuk mengirim pesan.");const{error:o}=await N.rpc("send_parent_message",{student_id_param:r.id,access_code_param:r.access_code,message_param:a,teacher_user_id_param:l.user_id});if(o)throw o},onSuccess:()=>{i.invalidateQueries({queryKey:["portalData",r.id]}),p("")},onError:a=>t.error(`Gagal mengirim pesan: ${a.message}`)}),{mutate:f,isPending:b}=P({mutationFn:async({messageId:a,newMessageText:o})=>{if(!r.access_code)throw new Error("Kode akses tidak valid.");const{error:s}=await N.rpc("update_parent_message",{student_id_param:r.id,access_code_param:r.access_code,message_id_param:a,new_message_param:o});if(s)throw s},onSuccess:()=>{i.invalidateQueries({queryKey:["portalData",r.id]}),t.success("Pesan berhasil diperbarui."),d({type:"closed",data:null})},onError:a=>t.error(`Gagal memperbarui pesan: ${a.message}`)}),{mutate:k,isPending:w}=P({mutationFn:async a=>{if(!r.access_code)throw new Error("Kode akses tidak valid.");const{error:o}=await N.rpc("delete_parent_message",{student_id_param:r.id,access_code_param:r.access_code,message_id_param:a});if(o)throw o},onSuccess:()=>{i.invalidateQueries({queryKey:["portalData",r.id]}),t.success("Pesan berhasil dihapus."),d({type:"closed",data:null})},onError:a=>t.error(`Gagal menghapus pesan: ${a.message}`)});return u.useEffect(()=>{var a;(a=j.current)==null||a.scrollIntoView({behavior:"smooth"})},[n]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col h-[60vh]",children:[e.jsx("div",{ref:j,className:"flex-1 overflow-y-auto p-4 space-y-4",children:n.map(a=>e.jsxs("div",{className:`group flex items-start gap-3 ${a.sender==="parent"?"justify-end":"justify-start"}`,children:[a.sender==="teacher"&&e.jsx("img",{src:l==null?void 0:l.avatar_url,className:"w-8 h-8 rounded-full object-cover flex-shrink-0",alt:"Guru"}),e.jsxs("div",{className:`relative max-w-md p-3 rounded-2xl text-sm ${a.sender==="parent"?"bg-blue-500 text-white rounded-br-none":"bg-gray-700 rounded-bl-none"}`,children:[e.jsx("p",{className:"whitespace-pre-wrap",children:a.message}),e.jsxs("div",{className:`flex items-center gap-1 text-xs mt-1 ${a.sender==="parent"?"text-blue-200 justify-end":"text-gray-400 justify-end"}`,children:[e.jsx("span",{children:new Date(a.created_at).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"})}),a.sender==="parent"&&a.is_read&&e.jsx(I,{className:"w-3.5 h-3.5"})]}),a.sender==="parent"&&e.jsxs("div",{className:"absolute top-0 -left-20 flex items-center space-x-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(x,{variant:"ghost",size:"icon",className:"h-7 w-7 bg-black/30",onClick:()=>d({type:"edit",data:a}),children:e.jsx(F,{className:"w-3.5 h-3.5"})}),e.jsx(x,{variant:"ghost",size:"icon",className:"h-7 w-7 bg-black/30 text-red-400",onClick:()=>d({type:"delete",data:a}),children:e.jsx(G,{className:"w-3.5 h-3.5"})})]})]}),a.sender==="parent"&&e.jsx("div",{className:"w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center flex-shrink-0",children:e.jsx(H,{className:"w-5 h-5 text-gray-300"})})]},a.id))}),e.jsxs("form",{onSubmit:a=>{a.preventDefault(),h.trim()&&v(h)},className:"p-4 border-t border-white/10 flex items-center gap-2",children:[e.jsx(Q,{value:h,onChange:a=>p(a.target.value),placeholder:"Ketik pesan...",className:"flex-1",disabled:g}),e.jsx(x,{type:"submit",size:"icon",disabled:g||!h.trim(),children:e.jsx(U,{className:"w-5 h-5"})})]})]}),m.type==="edit"&&m.data&&e.jsx(D,{title:"Edit Pesan",isOpen:!0,onClose:()=>d({type:"closed",data:null}),children:e.jsxs("form",{onSubmit:a=>{a.preventDefault();const s=new FormData(a.currentTarget).get("message");f({messageId:m.data.id,newMessageText:s})},children:[e.jsx("textarea",{name:"message",defaultValue:m.data.message,rows:5,className:"w-full mt-1 p-2 border rounded-md bg-white/10 border-white/20 text-white placeholder:text-gray-400"}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"ghost",onClick:()=>d({type:"closed",data:null}),children:"Batal"}),e.jsx(x,{type:"submit",disabled:b,children:b?"Menyimpan...":"Simpan"})]})]})}),m.type==="delete"&&m.data&&e.jsxs(D,{title:"Hapus Pesan",isOpen:!0,onClose:()=>d({type:"closed",data:null}),children:[e.jsx("p",{children:"Apakah Anda yakin ingin menghapus pesan ini?"}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(x,{type:"button",variant:"ghost",onClick:()=>d({type:"closed",data:null}),children:"Batal"}),e.jsx(x,{variant:"destructive",onClick:()=>k(m.data.id),disabled:w,children:w?"Menghapus...":"Hapus"})]})]})]})},se=()=>{const{studentId:n}=R(),r=E(),l=sessionStorage.getItem("portal_access_code"),{data:t,isLoading:i,isError:h,error:p}=T({queryKey:["portalData",n],queryFn:()=>Y(n,l),enabled:!!n&&!!l,retry:!1});u.useEffect(()=>{l||r("/portal-login",{replace:!0}),h&&(console.error("Portal Data Fetch Error:",p),sessionStorage.removeItem("portal_access_code"),r("/portal-login",{replace:!0}))},[l,h,p,r]);const m=()=>{sessionStorage.removeItem("portal_access_code"),r("/",{replace:!0})},d=u.useMemo(()=>t?{present:t.attendanceRecords.filter(s=>s.status==="Hadir").length,absent:t.attendanceRecords.filter(s=>s.status!=="Hadir").length}:{present:0,absent:0},[t]),j=u.useMemo(()=>(t==null?void 0:t.violations.reduce((s,c)=>s+c.points,0))||0,[t]),v=u.useMemo(()=>{if(!t||t.academicRecords.length===0)return"N/A";const s=t.academicRecords.reduce((c,_)=>c+_.score,0);return Math.round(s/t.academicRecords.length)},[t]);if(i)return e.jsx("div",{className:"flex items-center justify-center h-screen cosmic-bg",children:e.jsx("div",{className:"w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"})});if(!t)return null;const{student:g,academicRecords:f,violations:b,communications:k,teacher:w,quizPoints:a,attendanceRecords:o}=t;return e.jsxs("div",{className:"min-h-screen w-full cosmic-bg text-white font-sans",children:[e.jsx(W,{student:g,onLogout:m}),e.jsxs("main",{className:"p-4 sm:p-6 md:p-8 max-w-7xl mx-auto",children:[e.jsxs("section",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6",children:[e.jsx(y,{icon:M,label:"Rata-rata Nilai",value:v,colorClass:"bg-gradient-to-br from-purple-500 to-indigo-500"}),e.jsx(y,{icon:I,label:"Total Hadir",value:d.present,colorClass:"bg-gradient-to-br from-green-500 to-emerald-500"}),e.jsx(y,{icon:$,label:"Total Absen",value:d.absent,colorClass:"bg-gradient-to-br from-yellow-500 to-orange-500"}),e.jsx(y,{icon:K,label:"Poin Pelanggaran",value:j,colorClass:"bg-gradient-to-br from-red-500 to-rose-500"})]}),e.jsx(J,{children:e.jsxs(V,{defaultValue:"akademik",className:"w-full",children:[e.jsx("div",{className:"p-2 border-b border-white/10",children:e.jsxs(O,{className:"bg-black/20",children:[e.jsx(S,{value:"akademik",children:"Akademik"}),e.jsx(S,{value:"perilaku",children:"Perilaku & Kehadiran"}),e.jsx(S,{value:"komunikasi",children:"Komunikasi"})]})}),e.jsxs(C,{value:"akademik",className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Hasil Belajar"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:f.length>0?f.map(s=>{const c=s.score>=75?"text-green-400":s.score>=60?"text-yellow-400":"text-red-400",_=s.score>=75?"border-green-500/30":s.score>=60?"border-yellow-500/30":"border-red-500/30";return e.jsx("div",{className:`p-4 rounded-xl border ${_} bg-white/5`,children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-lg",children:s.subject}),e.jsx("p",{className:"text-sm text-purple-300 -mt-1 font-semibold",children:s.assessment_name||"Penilaian Umum"}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:s.notes})]}),e.jsx("p",{className:`font-black text-4xl ${c}`,children:s.score})]})},s.id)}):e.jsx("p",{className:"text-gray-400 md:col-span-2",children:"Belum ada data nilai akademik."})}),e.jsx("h3",{className:"text-xl font-bold mt-8 mb-4",children:"Poin Keaktifan"}),e.jsx("div",{className:"space-y-2",children:a.length>0?a.map(s=>e.jsxs("div",{className:"p-3 rounded-lg bg-white/5 flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center",children:e.jsx(z,{className:"w-5 h-5 text-green-300"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:s.quiz_name}),e.jsx("p",{className:"text-xs text-gray-400",children:new Date(s.quiz_date).toLocaleDateString("id-ID")})]})]},s.id)):e.jsx("p",{className:"text-gray-400",children:"Belum ada poin keaktifan yang tercatat."})})]}),e.jsx(C,{value:"perilaku",className:"p-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Catatan Pelanggaran"}),e.jsx("div",{className:"space-y-3",children:b.length>0?b.map(s=>e.jsxs("div",{className:"p-3 rounded-lg bg-red-500/10 border border-red-500/30",children:[e.jsx("p",{className:"font-semibold",children:s.description}),e.jsxs("p",{className:"text-xs text-gray-400",children:[new Date(s.date).toLocaleDateString("id-ID")," - ",e.jsxs("span",{className:"font-bold text-red-400",children:[s.points," poin"]})]})]},s.id)):e.jsx("p",{className:"text-gray-400",children:"Tidak ada catatan pelanggaran. Perilaku siswa sangat baik."})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Riwayat Kehadiran"}),e.jsxs("div",{className:"space-y-2",children:[o.length>0?[...o].sort((s,c)=>new Date(c.date).getTime()-new Date(s.date).getTime()).slice(0,10).map(s=>{const c={Hadir:{color:"text-green-400",bg:"bg-green-500/10"},Izin:{color:"text-yellow-400",bg:"bg-yellow-500/10"},Sakit:{color:"text-blue-400",bg:"bg-blue-500/10"},Alpha:{color:"text-red-400",bg:"bg-red-500/10"}}[s.status];return e.jsxs("div",{className:`p-3 rounded-lg flex justify-between items-center ${c==null?void 0:c.bg}`,children:[e.jsx("p",{className:"font-medium",children:new Date(s.date).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long"})}),e.jsx("p",{className:`font-bold text-sm px-2 py-0.5 rounded-full ${c==null?void 0:c.color}`,children:s.status})]},s.id)}):e.jsx("p",{className:"text-gray-400",children:"Belum ada data kehadiran."}),o.length>10&&e.jsx("p",{className:"text-xs text-center text-gray-500 mt-2",children:"Menampilkan 10 catatan terakhir..."})]})]})]})}),e.jsx(C,{value:"komunikasi",children:e.jsx(X,{communications:k,student:g,teacher:w})})]})})]})]})};export{se as ParentPortalPage};
